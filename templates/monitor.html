{% extends 'base.html' %}
{% block content %}
    <div>
        <h1>MONITOR</h1>
        <p>Connections: <span id="connections">?</span></p>

        <div id="clients">

        </div>

        <div id="ratingSectionImages" style="flex-direction: column; position: absolute; top: 500px;"></div>
    </div>

    <script type="text/javascript">
        let socket = io();
        const connectionsElement = document.querySelector('#connections');
        const clientsElement = document.querySelector('#clients');
        const ratingSectionImages = document.querySelector("#ratingSectionImages");

        async function freshData() {
            const resp = await fetch("/gamedata?key={{ globals.key }}");
            const data = await resp.json();

            connectionsElement.innerText = data['connections'];
            clientsElement.innerHTML = "";

            for (let username of data['usernames']) {
                await addClient(username);
            }
        }

        socket.on('rating_data', data => {
            ratingSectionImages.innerHTML = "";

            for (let user of data['users']) {
                ratingSectionImages.innerHTML += `<div id="rating-${user}"><img draggable=false src='/drawing/${user}?t=${Date.now()}'/><a onclick='kick("${user}")' href='#'><div style='flex-direction: row'>Kick user</a><button onclick="submitRating(1, '${user}')">1/3</button><button onclick="submitRating(2, '${user}')">2/3</button><button onclick="submitRating(3, '${user}')">3/3</button></div><hr/></div>`
            }
        });

        socket.on('set_page', page => {
            if (page === "draw") {
                ratingSectionImages.innerHTML = "";
            }
        });

        socket.on('client_connected', (amount) => {
            connectionsElement.innerText = amount;
        });

        socket.on('identify', async (data) => {
            await addClient(data['username']);
        });

        socket.on('monitor_remove_rating', (user) => {
            document.getElementById(`rating-${user}`).remove();
        });

        async function submitRating(rating, user) {
            socket.emit('admin_rating', {"username": user, "rating": rating});
        }

        async function addClient(username) {
            let clientElement = document.createElement('p');
            clientElement.id = "client-" + username;
            clientElement.innerText = username;
            clientElement.addEventListener('click', async (event) => {
                socket.emit('kick', username);
            });
            clientsElement.append(clientElement);
        }

        socket.on('client_disconnected', (data) => {
            connectionsElement.innerText = data['amount'];
            document.getElementById('client-' + data['username']).remove();
        });

        function kick(username) {
            socket.emit('kick', username);
        }

        freshData();
    </script>
{% endblock %}