{% extends 'base.html' %}
{% block content %}
    <div>
        <h1>MONITOR</h1>
        <p>Connections: <span id="connections">?</span></p>

        <div id="clients">

        </div>
    </div>

    <script type="text/javascript">
        let socket = io();
        const connectionsElement = document.querySelector('#connections');
        const clientsElement = document.querySelector('#clients');

        async function freshData() {
            const resp = await fetch("/gamedata?key={{ globals.key }}");
            const data = await resp.json();

            connectionsElement.innerText = data['connections'];
            clientsElement.innerHTML = "";

            for (let username of data['usernames']) {
                await addClient(username);
            }
        }

        socket.on('client_connected', (amount) => {
            connectionsElement.innerText = amount;
        });

        socket.on('identify', async (data) => {
            await addClient(data['username']);
        });

        async function addClient(username) {
            let clientElement = document.createElement('p');
            clientElement.id = "client-" + username;
            clientElement.innerText = username;
            clientElement.addEventListener('click', async (event) => {
                socket.emit('kick', username);
            });
            clientsElement.append(clientElement);
        }

        socket.on('client_disconnected', (data) => {
            connectionsElement.innerText = data['amount'];
            document.getElementById('client-' + data['username']).remove();
        });

        freshData();
    </script>
{% endblock %}